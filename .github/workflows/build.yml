name: Build Mobile Apps

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Web Assets
        run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Capacitor Add/Sync Android
        run: |
          npx cap add android || true
          npx cap sync android

      - name: Decode Keystore
        run: |
          mkdir -p android/app
          echo "${{ secrets.ANDROID_SIGNING_KEY }}" | base64 --decode > android/app/release.keystore
          # Cheat Code: Try to list aliases. It may ask for a password and fail, but often prints info first.
          keytool -list -v -keystore android/app/release.keystore -storepass ${{ secrets.ANDROID_KEYSTORE_PASSWORD }} | grep "Alias name" || true

      - name: Build Android App Bundle (.aab)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/android/app/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=mealgenna_key \
            -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload .aab Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mealgenna-android-aab
          path: android/app/build/outputs/bundle/release/app-release.aab

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Web Assets
        run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Capacitor Add/Sync iOS
        run: |
          npx cap add ios || true
          npx cap sync ios
          # Fix Pods signing safely

      - name: Clean and Install Pods
        run: |
          cd ios/App
          echo "Performing Clean Slate cleanup..."
          rm -rf Pods
          rm -f Podfile.lock
          rm -rf App.xcworkspace
          
          echo "Clearing Local Pod Cache..."
          pod cache clean --all
          
          echo "Installing Pods..."
          pod repo update
          pod install
          cd ../..

      - name: Install Apple Certificate
        shell: python
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          import os, base64, subprocess, re
          # Clean inputs
          raw_p12 = os.environ.get('P12_BASE64', '')
          p12_content = re.sub(r'[^A-Za-z0-9+/=]', '', raw_p12)
          with open('release.p12', 'wb') as f:
              f.write(base64.b64decode(p12_content))
          
          # Create and setup temporary keychain
          pw = os.environ.get('P12_PASSWORD', 'MealMind2026')
          subprocess.run(['security', 'create-keychain', '-p', pw, 'build.keychain'], check=True)
          subprocess.run(['security', 'set-keychain-settings', '-lut', '21600', 'build.keychain'], check=True)
          subprocess.run(['security', 'unlock-keychain', '-p', pw, 'build.keychain'], check=True)
          
          # Import certificate
          subprocess.run(['security', 'import', 'release.p12', '-k', 'build.keychain', '-P', pw, '-A', '-t', 'cert', '-f', 'pkcs12'], check=True)
          subprocess.run(['security', 'set-key-partition-list', '-S', 'apple-tool:,apple:,codesign:', '-s', '-k', pw, 'build.keychain'], check=True)
          
          # Add to search list
          subprocess.run(['security', 'list-keychains', '-d', 'user', '-s', 'build.keychain', 'login.keychain'], check=True)

      - name: Decode Provisioning Profile
        shell: python
        env:
          PROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
        run: |
          import os, base64, re, plistlib
          # 1. Clean and Build path
          dest = os.path.expanduser('~/Library/MobileDevice/Provisioning Profiles')
          os.makedirs(dest, exist_ok=True)
          raw_pp = os.environ.get('PROVISION_BASE64', '')
          pp_content = base64.b64decode(re.sub(r'[^A-Za-z0-9+/=]', '', raw_pp))
          
          # 2. Extract the Plist part from the CMS/PKCS7 bundle
          start_tag = b'<?xml'
          end_tag = b'</plist>'
          start = pp_content.find(start_tag)
          end = pp_content.find(end_tag) + len(end_tag)
          plist_data = pp_content[start:end]
          
          # 3. Parse Data
          data = plistlib.loads(plist_data)
          uuid = data['UUID']
          name = data['Name']
          print(f"Detected Profile: {name} (UUID: {uuid})")
          
          # 4. Save with UUID filename (Apple requirement)
          with open(os.path.join(dest, f"{uuid}.mobileprovision"), 'wb') as f:
              f.write(pp_content)
              
          # 5. Export to GitHub Env for next steps
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"PROVISION_UUID={uuid}\n")
              f.write(f"PROVISION_NAME={name}\n")

      - name: Create ExportOptions.plist
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_DEVELOPMENT_TEAM_ID }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.nesberry.mealgenna.pro</key>
              <string>$PROVISION_UUID</string>
            </dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
          </dict>
          </plist>
          EOF

      - name: Debug Provisioning
        run: |
          echo "Detected UUID: $PROVISION_UUID"
          echo "Detected Name: $PROVISION_NAME"

      - name: Clear Xcode Cache
        run: |
          rm -rf ~/Library/Developer/Xcode/DerivedData
          mkdir -p output

      - name: Build iOS Archive (.archive)
        run: |
          # Verify node_modules for Podfile references
          ls -d node_modules/@capacitor/ios || (echo "ERROR: node_modules missing!" && exit 1)
          
          xcodebuild archive -workspace ios/App/App.xcworkspace \
                     -scheme App \
                     -sdk iphoneos \
                     -configuration Release \
                     -archivePath App.xcarchive \
                     -destination 'generic/platform=iOS' \
                     DEVELOPMENT_TEAM=${{ secrets.APPLE_DEVELOPMENT_TEAM_ID }} \
                     CODE_SIGN_STYLE=Manual \
                     CODE_SIGN_IDENTITY="Apple Distribution" \
                     PROVISIONING_PROFILE_SPECIFIER=$PROVISION_UUID \
                     IPHONEOS_DEPLOYMENT_TARGET=13.0 \
                     -allowProvisioningUpdates
                     
          xcodebuild -exportArchive \
                     -archivePath App.xcarchive \
                     -exportOptionsPlist ExportOptions.plist \
                     -exportPath output \
                     -allowProvisioningUpdates

      - name: Upload to TestFlight
        env:
          API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # 1. Setup API Key for altool/transporter
          mkdir -p ~/private_keys
          
          # Write the API key content to file (preserve exact formatting)
          # The secret should contain the raw .p8 file content including header/footer
          printf "%s" "$API_KEY_CONTENT" > ~/private_keys/AuthKey_${API_KEY_ID}.p8
          
          # Verify the key file was created and check format
          echo "=== Key file created ==="
          ls -la ~/private_keys/
          echo "=== First few lines of key file ==="
          head -n 3 ~/private_keys/AuthKey_${API_KEY_ID}.p8
          echo "=== Last few lines of key file ==="
          tail -n 3 ~/private_keys/AuthKey_${API_KEY_ID}.p8
          
          # 2. Find the IPA file
          IPA_PATH=$(find output -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA file found to upload!"
            exit 1
          fi
          echo "Uploading $IPA_PATH..."
          
          # 3. Upload using xcrun altool with proper authentication
          # altool is deprecated but still works for upload-app
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID" \
            --verbose

      - name: Upload .ipa Artifact
        if: always() # Ensure we get the artifact even if upload fails
        uses: actions/upload-artifact@v4
        with:
          name: mealgenna-ios-ipa
          path: output/*.ipa
