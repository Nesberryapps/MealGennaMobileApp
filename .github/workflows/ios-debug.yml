name: iOS Debug Build
on:
  workflow_dispatch:

jobs:
  debug-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Web Assets
        run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Capacitor Add/Sync iOS
        run: |
          npx cap add ios || true
          npx cap sync ios

      - name: Clean Slate Pod Installation
        run: |
          cd ios/App
          echo "Removing Pods and Lockfile..."
          rm -rf Pods
          rm -f Podfile.lock
          rm -rf App.xcworkspace
          
          echo "Clearing Local Pod Cache..."
          pod cache clean --all
          
          echo "Installing Pods (Verbose)..."
          pod install --verbose
          
          echo "=== PODFILE.LOCK CONTENT START ==="
          cat Podfile.lock
          echo "=== PODFILE.LOCK CONTENT END ==="
          cd ../..

      - name: Install Apple Certificate
        shell: python
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          import os, base64, subprocess, re
          raw_p12 = os.environ.get('P12_BASE64', '')
          p12_content = re.sub(r'[^A-Za-z0-9+/=]', '', raw_p12)
          with open('release.p12', 'wb') as f:
              f.write(base64.b64decode(p12_content))
          
          pw = os.environ.get('P12_PASSWORD', 'MealMind2026')
          subprocess.run(['security', 'create-keychain', '-p', pw, 'build.keychain'], check=True)
          subprocess.run(['security', 'set-keychain-settings', '-lut', '21600', 'build.keychain'], check=True)
          subprocess.run(['security', 'unlock-keychain', '-p', pw, 'build.keychain'], check=True)
          subprocess.run(['security', 'import', 'release.p12', '-k', 'build.keychain', '-P', pw, '-A', '-t', 'cert', '-f', 'pkcs12'], check=True)
          subprocess.run(['security', 'set-key-partition-list', '-S', 'apple-tool:,apple:,codesign:', '-s', '-k', pw, 'build.keychain'], check=True)

      - name: Decode Provisioning Profile
        shell: python
        env:
          PROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
        run: |
          import os, base64, re, plistlib
          dest = os.path.expanduser('~/Library/MobileDevice/Provisioning Profiles')
          os.makedirs(dest, exist_ok=True)
          raw_pp = os.environ.get('PROVISION_BASE64', '')
          pp_content = base64.b64decode(re.sub(r'[^A-Za-z0-9+/=]', '', raw_pp))
          
          start_tag = b'<?xml'
          end_tag = b'</plist>'
          start = pp_content.find(start_tag)
          end = pp_content.find(end_tag) + len(end_tag)
          plist_data = pp_content[start:end]
          data = plistlib.loads(plist_data)
          uuid = data['UUID']
          
          with open(os.path.join(dest, f"{uuid}.mobileprovision"), 'wb') as f:
              f.write(pp_content)
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"PROVISION_UUID={uuid}\n")

      - name: Build with Verbose Logging
        run: |
          echo "Building with -verbose to capture errors..."
          xcodebuild archive -workspace ios/App/App.xcworkspace \
                     -scheme App \
                     -sdk iphoneos \
                     -configuration Release \
                     -archivePath App.xcarchive \
                     -destination 'generic/platform=iOS' \
                     DEVELOPMENT_TEAM=${{ secrets.APPLE_DEVELOPMENT_TEAM_ID }} \
                     CODE_SIGN_STYLE=Manual \
                     CODE_SIGN_IDENTITY="Apple Distribution" \
                     PROVISIONING_PROFILE_SPECIFIER=$PROVISION_UUID \
                     IPHONEOS_DEPLOYMENT_TARGET=13.0 \
                     -allowProvisioningUpdates \
                     -verbose > build_log.txt 2>&1 || true
                     
          echo "Listing output files:"
          ls -l build_log.txt
          
          # Print the last 200 lines to the console for quick reference
          echo "=== TAIL OF BUILD LOG ==="
          tail -n 200 build_log.txt

      - name: Upload Build Log
        uses: actions/upload-artifact@v4
        with:
          name: full-ios-build-log
          path: build_log.txt
