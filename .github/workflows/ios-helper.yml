name: iOS Certificate Helper

on:
  workflow_dispatch:
    inputs:
      step:
        description: 'Which step to run'
        required: true
        default: '1-generate-csr'
        type: choice
        options:
          - '1-generate-csr'
          - '2-create-p12'
      private_key:
        description: 'Paste the Private Key (for Step 2)'
        required: false
      cert_base64:
        description: 'Paste the .cer base64 string'
        required: false
      p12_password:
        description: 'Choose a password for your .p12'
        required: false
        default: 'MealMind2026'

jobs:
  helper:
    runs-on: macos-latest
    steps:
      - name: Step 1 - Generate CSR
        if: ${{ github.event.inputs.step == '1-generate-csr' }}
        run: |
          openssl genrsa -out private.key 2048
          openssl req -new -key private.key -out request.csr -subj "/Email=shemh@example.com/CN=MealGenna/C=US"
          echo "----------------- COPY THE CSR BELOW -----------------"
          cat request.csr
          echo "-------------- COPY THE PRIVATE KEY BELOW --------------"
          cat private.key
          
      - name: Step 2 - Create P12 (Ironclad Version)
        if: ${{ github.event.inputs.step == '2-create-p12' }}
        shell: python
        env:
          RAW_PRIVATE_KEY: ${{ github.event.inputs.private_key }}
          RAW_CERT_BASE64: ${{ github.event.inputs.cert_base64 }}
          P12_PASSWORD: ${{ github.event.inputs.p12_password }}
        run: |
          import os
          import base64
          import subprocess
          import re

          # Helper to clean strings
          def clean_it(s):
              return re.sub(r'[^A-Za-z0-9+/=]', '', s)

          # Process Private Key
          raw_pk = os.environ.get('RAW_PRIVATE_KEY', '')
          pk_content = clean_it(raw_pk.replace('BEGIN RSA PRIVATE KEY', '').replace('END RSA PRIVATE KEY', ''))
          final_pk = f"-----BEGIN RSA PRIVATE KEY-----\n{pk_content}\n-----END RSA PRIVATE KEY-----"
          
          with open('private.key', 'w') as f:
              f.write(final_pk)

          # Process Certificate
          raw_cb64 = os.environ.get('RAW_CERT_BASE64', '')
          cert_content = clean_it(raw_cb64)
          
          if not cert_content:
              print("Error: Certificate data is empty!")
              exit(1)

          with open('distribution.cer', 'wb') as f:
              f.write(base64.b64decode(cert_content))

          # Run OpenSSL Commands
          try:
              # Convert DER to CRT
              subprocess.run(['openssl', 'x509', '-in', 'distribution.cer', '-inform', 'DER', '-out', 'distribution.crt'], check=True)
              
              # Create P12
              pw = os.environ.get('P12_PASSWORD', 'MealMind2026')
              subprocess.run(['openssl', 'pkcs12', '-export', '-out', 'release.p12', '-inkey', 'private.key', '-in', 'distribution.crt', '-password', f'pass:{pw}'], check=True)

              # Output Result
              print("\n----------------- YOUR P12 IS READY -----------------")
              with open('release.p12', 'rb') as f:
                  print(base64.b64encode(f.read()).decode('utf-8'))
              print("----------------- END OF BASE64 -----------------")
          except subprocess.CalledProcessError as e:
              print(f"OpenSSL failed: {e}")
              exit(1)