name: iOS Certificate Helper

on:
  workflow_dispatch:
    inputs:
      step:
        description: 'Which step to run'
        required: true
        default: '1-generate-csr'
        type: choice
        options:
          - '1-generate-csr'
          - '2-create-p12'
      private_key:
        description: 'Paste the Private Key (for Step 2)'
        required: false
      cert_base64:
        description: 'Paste the .cer base64 string'
        required: false
      p12_password:
        description: 'Choose a password for your .p12'
        required: false
        default: 'MealMind2026'

jobs:
  helper:
    runs-on: macos-latest
    steps:
      - name: Step 1 - Generate CSR
        if: ${{ github.event.inputs.step == '1-generate-csr' }}
        run: |
          openssl genrsa -out private.key 2048
          openssl req -new -key private.key -out request.csr -subj "/Email=shemh@example.com/CN=MealGenna/C=US"
          echo "----------------- COPY THE CSR BELOW -----------------"
          cat request.csr
          echo "----------------- COPY THE PRIVATE KEY BELOW -----------------"
          cat private.key
          
      - name: Step 2 - Create P12 (Python Version)
        if: ${{ github.event.inputs.step == '2-create-p12' }}
        shell: python
        env:
          RAW_PRIVATE_KEY: ${{ github.event.inputs.private_key }}
          RAW_CERT_BASE64: ${{ github.event.inputs.cert_base64 }}
          P12_PASSWORD: ${{ github.event.inputs.p12_password }}
        run: |
          import os
          import base64
          import subprocess

          # Get inputs safely from environment
          pk = os.environ.get('RAW_PRIVATE_KEY', '').replace('"', '').strip()
          cb64 = os.environ.get('RAW_CERT_BASE64', '').replace('"', '').replace(' ', '').replace('\n', '').replace('\r', '').strip()
          pw = os.environ.get('P12_PASSWORD', 'MealMind2026')

          if not pk or not cb64:
              print("Error: Private Key or Certificate Base64 is missing!")
              exit(1)

          # Save Private Key
          with open('private.key', 'w') as f:
              f.write(pk)

          # Decode Certificate
          try:
              cert_data = base64.b64decode(cb64)
              with open('distribution.cer', 'wb') as f:
                  f.write(cert_data)
          except Exception as e:
              print(f"Error decoding base64: {e}")
              exit(1)

          # Step 2a: Convert DER to CRT
          subprocess.run(['openssl', 'x509', '-in', 'distribution.cer', '-inform', 'DER', '-out', 'distribution.crt'], check=True)
          
          # Step 2b: Create P12
          subprocess.run(['openssl', 'pkcs12', '-export', '-out', 'release.p12', '-inkey', 'private.key', '-in', 'distribution.crt', '-password', f'pass:{pw}'], check=True)

          # Step 2c: Output Final Base64
          print("\n----------------- YOUR P12 IS READY -----------------")
          with open('release.p12', 'rb') as f:
              p12_content = f.read()
              print(base64.b64encode(p12_content).decode('utf-8'))
          print("----------------- END OF BASE64 -----------------")