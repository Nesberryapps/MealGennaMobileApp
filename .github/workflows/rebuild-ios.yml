name: Nuclear iOS Rebuild
on:
  workflow_dispatch:

jobs:
  rebuild-and-build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Web Assets
        run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: DELETE Existing iOS Project
        run: |
          echo "WARNING: Deleting ios directory for a fresh start..."
          rm -rf ios

      - name: Generate Fresh iOS Project
        run: |
          npx cap add ios
          npx cap sync ios

      - name: Patch project.pbxproj for Manual Signing
        run: |
          # Force ProvisioningStyle to Manual so xcodebuild arguments take effect
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/' ios/App/App.xcodeproj/project.pbxproj
          echo "Patched project.pbxproj to enforce Manual Signing."

      - name: Inject Configuration into Info.plist
        shell: python
        run: |
          import os, plistlib

          # Data to inject
          admob_app_id = "ca-app-pub-6191158195654090~8707594177"
          tracking_desc = "This identifier will be used to deliver personalized ads to you."
          camera_desc = "This app uses the camera to scan ingredients for meal analysis."
          
          sk_items = [
              {"SKAdNetworkIdentifier": "cstr6suwn9.skadnetwork"}
          ]

          plist_path = "ios/App/App/Info.plist"

          print(f"Reading {plist_path}...")
          with open(plist_path, 'rb') as f:
              plist_data = plistlib.load(f)

          # Inject keys
          plist_data['GADApplicationIdentifier'] = admob_app_id
          plist_data['NSUserTrackingUsageDescription'] = tracking_desc
          plist_data['NSCameraUsageDescription'] = camera_desc
          
          # Initialize or append SKAdNetworkItems
          if 'SKAdNetworkItems' not in plist_data:
              plist_data['SKAdNetworkItems'] = []
          
          # Avoid duplicates
          existing_ids = [item.get('SKAdNetworkIdentifier') for item in plist_data['SKAdNetworkItems']]
          for item in sk_items:
              if item['SKAdNetworkIdentifier'] not in existing_ids:
                  plist_data['SKAdNetworkItems'].append(item)

          print("Writing updated Info.plist...")
          with open(plist_path, 'wb') as f:
              plistlib.dump(plist_data, f)
          
          print("Successfully injected Info.plist keys via plistlib.")

      - name: Install Pods (Fresh & Uncached)
        run: |
          cd ios/App
          echo "Clearing Pod Cache to fix GitHub side issues..."
          pod cache clean --all
          pod repo update
          pod install
          cd ../..

      - name: Install Apple Certificate
        shell: python
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          import os, base64, subprocess, re
          raw_p12 = os.environ.get('P12_BASE64', '')
          p12_content = re.sub(r'[^A-Za-z0-9+/=]', '', raw_p12)
          with open('release.p12', 'wb') as f:
              f.write(base64.b64decode(p12_content))
          
          pw = os.environ.get('P12_PASSWORD', 'MealMind2026')
          subprocess.run(['security', 'create-keychain', '-p', pw, 'build.keychain'], check=True)
          subprocess.run(['security', 'set-keychain-settings', '-lut', '21600', 'build.keychain'], check=True)
          subprocess.run(['security', 'unlock-keychain', '-p', pw, 'build.keychain'], check=True)
          subprocess.run(['security', 'import', 'release.p12', '-k', 'build.keychain', '-P', pw, '-A', '-t', 'cert', '-f', 'pkcs12'], check=True)
          subprocess.run(['security', 'set-key-partition-list', '-S', 'apple-tool:,apple:,codesign:', '-s', '-k', pw, 'build.keychain'], check=True)

      - name: Decode Provisioning Profile
        shell: python
        env:
          PROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
        run: |
          import os, base64, re, plistlib
          dest = os.path.expanduser('~/Library/MobileDevice/Provisioning Profiles')
          os.makedirs(dest, exist_ok=True)
          raw_pp = os.environ.get('PROVISION_BASE64', '')
          pp_content = base64.b64decode(re.sub(r'[^A-Za-z0-9+/=]', '', raw_pp))
          
          start_tag = b'<?xml'
          end_tag = b'</plist>'
          start = pp_content.find(start_tag)
          end = pp_content.find(end_tag) + len(end_tag)
          plist_data = pp_content[start:end]
          data = plistlib.loads(plist_data)
          uuid = data['UUID']
          
          with open(os.path.join(dest, f"{uuid}.mobileprovision"), 'wb') as f:
              f.write(pp_content)
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"PROVISION_UUID={uuid}\n")

      - name: Build Archive (Verbose)
        run: |
          echo "Building with -verbose for debugging..."
          xcodebuild archive -workspace ios/App/App.xcworkspace \
                     -scheme App \
                     -sdk iphoneos \
                     -configuration Release \
                     -archivePath App.xcarchive \
                     -destination 'generic/platform=iOS' \
                     DEVELOPMENT_TEAM=${{ secrets.APPLE_DEVELOPMENT_TEAM_ID }} \
                     CODE_SIGN_STYLE=Manual \
                     CODE_SIGN_IDENTITY="Apple Distribution" \
                     PROVISIONING_PROFILE_SPECIFIER=$PROVISION_UUID \
                     IPHONEOS_DEPLOYMENT_TARGET=13.0 \
                     -allowProvisioningUpdates \
                     -verbose

      - name: Export Archive
        run: |
          # Generate ExportOptions.plist dynamically
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_DEVELOPMENT_TEAM_ID }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.nesberry.mealgenna.pro</key>
              <string>$PROVISION_UUID</string>
            </dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
                     -archivePath App.xcarchive \
                     -exportOptionsPlist ExportOptions.plist \
                     -exportPath output \
                     -allowProvisioningUpdates

      - name: Upload .ipa Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mealgenna-ios-ipa
          path: output/*.ipa
